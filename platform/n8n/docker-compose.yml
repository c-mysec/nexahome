# SSH Access
# docker exec -it n8n sh
networks:
  internal:
    external: true
  web:
    external: true
  edge:
    external: true

volumes:
  n8n_data:

services:
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped

    environment:
      # ─── Core ─────────────────────────────────────────────
      TZ: America/Sao_Paulo
      GENERIC_TIMEZONE: America/Sao_Paulo
      N8N_ENV: production
      N8N_LOG_LEVEL: info

      # ─── URLs (VERY IMPORTANT) ────────────────────────────
      N8N_HOST: hooks.nexahome.win
      N8N_PROTOCOL: https
      WEBHOOK_URL: https://hooks.nexahome.win
      N8N_ENDPOINT_WEBHOOK: webhook
      N8N_ENDPOINT_WEBHOOK_TEST: webhook-test

      # ─── Security ─────────────────────────────────────────
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER:-admin}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD:-super_strong_password}
      N8N_SECURE_COOKIE: false
      # N8N_SECURE_COOKIE: true # chatgpt ask to set this to true, but it causes issues with the LAN access, so we set it to false for now. We can revisit this later.

      # ─── Database (Postgres) ──────────────────────────────
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgresql
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB:-user}
      DB_POSTGRESDB_USER: ${POSTGRES_USER:-user}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD:-senha}

      # ─── Redis (recommended) ──────────────────────────────
      EXECUTIONS_MODE: queue
      QUEUE_BULL_REDIS_HOST: redis
      QUEUE_BULL_REDIS_PORT: 6379
      QUEUE_BULL_WORKER_CONCURRENCY: 5

      # ─── Files & permissions ──────────────────────────────
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: "true"

      # Disable telemetry & tracking
      N8N_DIAGNOSTICS_ENABLED: false
      N8N_TELEMETRY_ENABLED: false
      N8N_PERSONALIZATION_ENABLED: false

      # Optional: silence update checks
      N8N_VERSION_NOTIFICATIONS_ENABLED: false

    volumes:
      - n8n_data:/home/node/.n8n

    networks:
      - web
      - internal

    labels:
      - "traefik.docker.network=web"
      - "traefik.enable=true"
      # Webhooks (public via Cloudflare Tunnel)
      - "traefik.http.routers.n8n-webhooks.rule=Host(`hooks.nexahome.win`) && (PathPrefix(`/webhook`) || PathPrefix(`/webhook-test`))"
      - "traefik.http.routers.n8n-editor.entrypoints=web"
      #- "traefik.http.routers.n8n-webhooks.tls=true"
      # - "traefik.http.routers.n8n-webhooks.entrypoints=web"
      - "traefik.http.routers.n8n-webhooks.service=n8n"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"

      # ─── Editor (secured, public domain) ──────────────────────
      - "traefik.http.routers.n8n-editor.rule=Host(`hooks.nexahome.win`)"
      - "traefik.http.routers.n8n-editor.entrypoints=web"
      # - "traefik.http.routers.n8n-editor.tls=true"
      # - "traefik.http.routers.n8n-editor.entrypoints=web"
      - "traefik.http.routers.n8n-editor.middlewares=security-headers@file,compress-content@file,app-rateLimit@file"
      - "traefik.http.routers.n8n-editor.service=n8n"
  n8n-backup:
    image: ghcr.io/c-mysec/postgres-backup:latest
    profiles: ["backup"]
    environment: &pg_env
      POSTGRES_HOST: postgresql
      POSTGRES_DB: ${POSTGRES_DB:-db}
      POSTGRES_USER: ${POSTGRES_USER:-user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-senha}
      PGPASSWORD: ${POSTGRES_PASSWORD:-senha}
      OCI_BUCKET: ${OCI_BUCKET:-nexahome-backups}
      OCI_PREFIX: ${OCI_PREFIX:-postgres}
      TZ: America/Sao_Paulo
    networks:
      - internal
      - edge
    volumes:
      - ./backup/rclone:/root/.config/rclone:ro

  n8n-restore:
    image: ghcr.io/c-mysec/postgres-backup:latest
    profiles: ["restore"]
    environment: *pg_env
    command: ["/backup/restore.sh"]
    networks:
      - internal
      - edge
    volumes:
      - ./backup/rclone:/root/.config/rclone:ro
